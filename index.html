<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–∑–Ω–∞—é —Ç–≤–æ—é –¥—É—à—É –ª—É—á—à–µ üí´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.2em;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .question-text {
            font-size: 1.3em;
            color: #555;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .user-input {
            width: 100%;
            min-height: 120px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1.1em;
            font-family: 'Arial', sans-serif;
            resize: vertical;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .user-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .character-count {
            text-align: right;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .formulation-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin: 25px 0;
            text-align: left;
            display: none;
        }

        .formulation-text {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .poem-container {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            text-align: center;
        }

        .poem-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            font-style: italic;
        }

        .poem-text {
            font-size: 1.3em;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-line;
        }

        .progress {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 25px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .suggestion-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
        }

        .suggestion-btn {
            padding: 8px 16px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .suggestion-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .admin-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            text-align: left;
        }

        .admin-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .admin-info {
            font-size: 0.9em;
            color: #666;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="screen-welcome">
            <h1>üíñ –†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ –æ —Å–µ–±–µ</h1>
            <p class="question-text">
                –≠—Ç–æ—Ç –æ–ø—Ä–æ—Å–Ω–∏–∫ –æ—Å–æ–±–µ–Ω–Ω—ã–π - –∑–¥–µ—Å—å –Ω–µ—Ç –≥–æ—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤!<br>
                –ü–∏—à–∏ –≤—Å—ë, —á—Ç–æ –ø—Ä–∏–¥—ë—Ç –≤ –≥–æ–ª–æ–≤—É, –∞ —è –ø–æ–º–æ–≥—É –∫—Ä–∞—Å–∏–≤–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –º—ã—Å–ª–∏.<br>
                –í –∫–æ–Ω—Ü–µ —Ç–µ–±—è –∂–¥—ë—Ç –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ! ‚ú®
            </p>
            <div class="buttons">
                <button class="btn btn-primary" onclick="startQuestions()">–ù–∞—á–∞—Ç—å –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä üí´</button>
            </div>

            <div class="admin-section">
                <h3>ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞–º–∏ —á–µ—Ä–µ–∑ Telegram</h3>
                <div class="admin-info">
                    <strong>–î–æ–±–∞–≤—å –±–æ—Ç–∞:</strong> @AlishaQuestionBot<br>
                    <strong>–ö–æ–º–∞–Ω–¥—ã:</strong><br>
                    ‚Ä¢ /start - –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã<br>
                    ‚Ä¢ /questions - —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤<br>
                    ‚Ä¢ /add_bulk - –º–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤<br>
                    ‚Ä¢ /edit - –∏–∑–º–µ–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å<br>
                    ‚Ä¢ /delete - —É–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å<br>
                    ‚Ä¢ /refresh - –æ–±–Ω–æ–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã<br><br>
                    
                    <strong>–£–º–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è /add_bulk:</strong><br>
                    <code>üíí –°–≤–∞–¥—å–±–∞|–í–æ–ø—Ä–æ—Å?|–ø–æ–¥—Å–∫–∞–∑–∫–∏|–Ø –º–µ—á—Ç–∞—é –æ {–æ—Ç–≤–µ—Ç.–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π};–î–ª—è –º–µ–Ω—è –≤–∞–∂–Ω–æ {–æ—Ç–≤–µ—Ç.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π};–•–æ—á—É —á—Ç–æ–±—ã {–æ—Ç–≤–µ—Ç.—Å–æ—é–∑}</code><br>
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: {–æ—Ç–≤–µ—Ç}, {–æ—Ç–≤–µ—Ç.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π}, {–æ—Ç–≤–µ—Ç.–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π}, {–æ—Ç–≤–µ—Ç.—Å–æ—é–∑}
                </div>
            </div>
        </div>

        <div id="questions-container"></div>

        <div id="screen-final" style="display: none;">
            <h1>–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ—Å—Ç—å! üíñ</h1>
            <div class="poem-container" id="finalPoem">
                <!-- –°—é–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ -->
            </div>
            <p class="question-text">–¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–º–æ–≥–ª–∏ –º–Ω–µ –ø–æ–Ω—è—Ç—å —Ç–µ–±—è –≥–æ—Ä–∞–∑–¥–æ –ª—É—á—à–µ! ‚ú®</p>
            <div class="buttons">
                <button class="btn btn-success" onclick="restartQuiz()">üîÑ –ü—Ä–æ–π—Ç–∏ –µ—â—ë —Ä–∞–∑</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const BOT_TOKEN = '8519621124:AAEtDBYSAeNW16UQiAGy0epAwwt989v9Tzs';
        const CHAT_ID = '1490495592';
        const JSONBIN_ID = '690bda1cae596e708f473589';
        const JSONBIN_API_KEY = '$2a$10$nFkbrwHZpy3T9KrGUS6RxecAFiNTyKuGe.DZjFqoWYEUcbGS27YRC';

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let userAnswers = {};
        let currentQuestion = 0;
        let questions = [];
        let lastUpdateId = 0;

        // ==================== –£–ú–ù–´–ï –§–û–†–ú–£–õ–ò–†–û–í–ö–ò ====================
        function applySmartTemplate(template, userText) {
            const cleanText = userText.trim().replace(/[.!?]$/, '');
            const lowerText = cleanText.toLowerCase();
            
            // –†–∞–∑–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å —É–º–Ω—ã–º–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è–º–∏
            return template
                .replace(/{–æ—Ç–≤–µ—Ç\.–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π}/g, formatPrepositional(lowerText))
                .replace(/{–æ—Ç–≤–µ—Ç\.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π}/g, formatNominative(cleanText))
                .replace(/{–æ—Ç–≤–µ—Ç\.—Å–æ—é–∑}/g, formatConjunction(lowerText))
                .replace(/{–æ—Ç–≤–µ—Ç}/g, lowerText);
        }

        function formatPrepositional(text) {
            // –ü—Ä–µ–¥–ª–æ–∂–Ω—ã–π –ø–∞–¥–µ–∂ (–æ —á—ë–º? –æ –∫–æ–º?) - "–æ –ª—é–±–≤–∏", "–æ —Å—á–∞—Å—Ç—å–µ"
            if (text.endsWith('–∞') || text.endsWith('—è')) {
                return text.slice(0, -1) + '–µ'; // –ª—é–±–æ–≤—å -> –æ –ª—é–±–≤–∏, –º–µ—á—Ç–∞ -> –æ –º–µ—á—Ç–µ
            }
            if (text.endsWith('–æ—Å—Ç—å') || text.endsWith('–∞—Å—Ç—å')) {
                return text.slice(0, -2) + '–æ—Å—Ç–∏'; // —Ä–∞–¥–æ—Å—Ç—å -> –æ —Ä–∞–¥–æ—Å—Ç–∏
            }
            if (text.endsWith('–∏–µ')) {
                return text.slice(0, -1) + '–∏'; // –≤–Ω–∏–º–∞–Ω–∏–µ -> –æ –≤–Ω–∏–º–∞–Ω–∏–∏
            }
            return text;
        }

        function formatNominative(text) {
            // –ò–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ (—á—Ç–æ? –∫—Ç–æ?) - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ —Å –±–æ–ª—å—à–æ–π –±—É–∫–≤—ã
            return text.charAt(0).toUpperCase() + text.slice(1);
        }

        function formatConjunction(text) {
            // –î–ª—è —Å–æ—é–∑–∞ "—á—Ç–æ–±—ã" - –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–∫–æ–Ω—á–∞–Ω–∏–µ
            if (text.endsWith('—Ç—å')) {
                return text + '—å'; // –º–µ—á—Ç–∞—Ç—å -> —á—Ç–æ–±—ã –º–µ—á—Ç–∞—Ç—å
            }
            if (text.endsWith('—Ç—å—Å—è')) {
                return text; // –∑–∞–Ω–∏–º–∞—Ç—å—Å—è -> —á—Ç–æ–±—ã –∑–∞–Ω–∏–º–∞—Ç—å—Å—è
            }
            if (text.endsWith('–∞') || text.endsWith('—è')) {
                return text.slice(0, -1) + '–ª–∞'; // –º–µ—á—Ç–∞ -> —á—Ç–æ–±—ã –º–µ—á—Ç–∞–ª–∞
            }
            return text;
        }

        function generateSmartFormulation(questionNum, userText) {
            const question = questions[questionNum - 1];
            
            if (question.templates && question.templates.length > 0) {
                const template = question.templates[Math.floor(Math.random() * question.templates.length)];
                return applySmartTemplate(template, userText);
            }
            
            return generateFallbackFormulation(questionNum, userText);
        }

        function generateFallbackFormulation(questionNum, userText) {
            const question = questions[questionNum - 1];
            const cleanText = userText.toLowerCase().replace(/[.!?]$/, '');
            
            const formulations = [
                `–Ø –¥—É–º–∞—é, —á—Ç–æ ${cleanText}`,
                `–î–ª—è –º–µ–Ω—è —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ ${cleanText}`,
                `–Ø —á—É–≤—Å—Ç–≤—É—é, —á—Ç–æ ${cleanText}`,
                `–ú–æ–π –æ–ø—ã—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ ${cleanText}`,
                `–Ø —Å—á–∏—Ç–∞—é, —á—Ç–æ ${cleanText}`
            ];
            
            return formulations[Math.floor(Math.random() * formulations.length)];
        }

        // ==================== JSONBIN –§–£–ù–ö–¶–ò–ò ====================
        async function loadQuestions() {
            try {
                console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ JSONBin...');
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ –í–æ–ø—Ä–æ—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data.record.questions);
                return data.record.questions || getDefaultQuestions();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
                return getDefaultQuestions();
            }
        }

        async function saveQuestions(newQuestions) {
            try {
                console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ JSONBin...');
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY,
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify({
                        questions: newQuestions,
                        last_updated: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ –í–æ–ø—Ä–æ—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', data);
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
                return false;
            }
        }

        function getDefaultQuestions() {
            return [
                {
                    id: 1,
                    text: "–û–ø–∏—à–∏, –≤ —á—ë–º —Ç–≤–æ—è —Å–∞–º–∞—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞? –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è –æ—Å–æ–±–µ–Ω–Ω—ã–º?",
                    theme: "üåü –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å",
                    suggestions: ["–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–ó–∞–±–æ—Ç–∞", "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å"],
                    templates: [
                        "–ú–æ—è —Å–∏–ª–∞ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ {–æ—Ç–≤–µ—Ç}",
                        "–Ø –æ—Å–æ–±–µ–Ω–Ω–æ —Ü–µ–Ω—é –≤ —Å–µ–±–µ: {–æ—Ç–≤–µ—Ç.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π}",
                        "–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–µ–Ω—è –æ—Å–æ–±–µ–Ω–Ω—ã–º: {–æ—Ç–≤–µ—Ç}",
                        "–ú–æ—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è —á–µ—Ä—Ç–∞ - {–æ—Ç–≤–µ—Ç}",
                        "–Ø –≥–æ—Ä–∂—É—Å—å —Å–≤–æ–µ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é {–æ—Ç–≤–µ—Ç.—Å–æ—é–∑}"
                    ]
                }
            ];
        }

        // ==================== TELEGRAM –ë–û–¢ –§–£–ù–ö–¶–ò–ò ====================
        async function sendTelegramMessage(chatId, text, parse_mode = 'Markdown') {
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: text,
                        parse_mode: parse_mode
                    })
                });

                const result = await response.json();
                if (!result.ok) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', result);
                }
                return result;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', error);
                return { ok: false, error: error.message };
            }
        }

        async function checkBotMessages() {
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}&timeout=5`);
                const data = await response.json();
                
                if (data.ok && data.result.length > 0) {
                    for (const update of data.result) {
                        if (update.update_id <= lastUpdateId) continue;
                        await processBotUpdate(update);
                        lastUpdateId = update.update_id;
                    }
                }
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            }
        }

        async function processBotUpdate(update) {
            const message = update.message;
            if (!message || !message.text) return;

            const chatId = message.chat.id;
            const text = message.text.trim();

            if (chatId == CHAT_ID) {
                await handleAdminCommand(text, chatId);
            }
        }

        async function handleAdminCommand(command, chatId) {
            console.log('üîß –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã:', command);
            const parts = command.split(' ');
            const mainCommand = parts[0];

            switch(mainCommand) {
                case '/start':
                    await sendAdminWelcome(chatId);
                    break;
                case '/questions':
                    await showQuestionsList(chatId);
                    break;
                case '/add_bulk':
                    await addBulkQuestions(chatId, command.substring(9)); // –ë–µ—Ä–µ–º –≤—Å—ë –ø–æ—Å–ª–µ /add_bulk
                    break;
                case '/edit':
                    await editQuestion(chatId, parts[1], parts.slice(2).join(' '));
                    break;
                case '/delete':
                    await deleteQuestion(chatId, parts[1]);
                    break;
                case '/refresh':
                    await refreshQuestions(chatId);
                    break;
                case '/help':
                    await showHelp(chatId);
                    break;
                default:
                    await sendTelegramMessage(chatId, '‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.');
            }
        }

        async function sendAdminWelcome(chatId) {
            const message = `ü§ñ *–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞–º–∏*

*–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/questions - —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤
/add_bulk - –º–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤
/edit - –∏–∑–º–µ–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å  
/delete - —É–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å
/refresh - –æ–±–Ω–æ–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã
/help - —Å–ø—Ä–∞–≤–∫–∞

*–£–º–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è /add_bulk:*
\`\`\`
üíí –°–≤–∞–¥—å–±–∞|–ö–∞–∫ —Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å —Å–≤–∞–¥—å–±—É?|–ú–µ—Å—Ç–æ,–ì–æ—Å—Ç–∏|–Ø –º–µ—á—Ç–∞—é –æ {–æ—Ç–≤–µ—Ç.–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π};–î–ª—è –º–µ–Ω—è –≤–∞–∂–Ω–æ {–æ—Ç–≤–µ—Ç.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π};–•–æ—á—É —á—Ç–æ–±—ã {–æ—Ç–≤–µ—Ç.—Å–æ—é–∑}
üå¥ –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è|–ö—É–¥–∞ —Ö–æ—á–µ—à—å –ø–æ–µ—Ö–∞—Ç—å?|–ü–ª—è–∂,–ì–æ—Ä—ã|–ú–µ—á—Ç–∞—é –æ {–æ—Ç–≤–µ—Ç.–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π};–•–æ—á—É —á—Ç–æ–±—ã {–æ—Ç–≤–µ—Ç.—Å–æ—é–∑};–î–ª—è –º–µ–Ω—è –≤–∞–∂–Ω–æ {–æ—Ç–≤–µ—Ç.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π}
\`\`\`
*–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã:*
‚Ä¢ {–æ—Ç–≤–µ—Ç} - –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç
‚Ä¢ {–æ—Ç–≤–µ—Ç.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π} - —Å –±–æ–ª—å—à–æ–π –±—É–∫–≤—ã
‚Ä¢ {–æ—Ç–≤–µ—Ç.–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π} - –≤ –ø—Ä–µ–¥–ª–æ–∂–Ω–æ–º –ø–∞–¥–µ–∂–µ (–æ —á—ë–º)
‚Ä¢ {–æ—Ç–≤–µ—Ç.—Å–æ—é–∑} - –¥–ª—è —Å–æ—é–∑–∞ "—á—Ç–æ–±—ã"`;

            await sendTelegramMessage(chatId, message);
        }

        async function showHelp(chatId) {
            const message = `üìñ *–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º*

*/questions* - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
*/add_bulk* - –º–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤
*/edit –Ω–æ–º–µ—Ä —Ç–µ–º–∞|–≤–æ–ø—Ä–æ—Å|–ø–æ–¥—Å–∫–∞–∑–∫–∏|—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏* - –∏–∑–º–µ–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å  
*/delete –Ω–æ–º–µ—Ä* - —É–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å
*/refresh* - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã

*–£–º–Ω—ã–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –¥–ª—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫:*
‚Ä¢ {–æ—Ç–≤–µ—Ç} - –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç
‚Ä¢ {–æ—Ç–≤–µ—Ç.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π} - —Ç–µ–∫—Å—Ç —Å –±–æ–ª—å—à–æ–π –±—É–∫–≤—ã
‚Ä¢ {–æ—Ç–≤–µ—Ç.–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π} - –≤ –ø—Ä–µ–¥–ª–æ–∂–Ω–æ–º –ø–∞–¥–µ–∂–µ
‚Ä¢ {–æ—Ç–≤–µ—Ç.—Å–æ—é–∑} - –¥–ª—è —Å–æ—é–∑–∞ "—á—Ç–æ–±—ã"`;

            await sendTelegramMessage(chatId, message);
        }

        async function showQuestionsList(chatId) {
            if (!questions || questions.length === 0) {
                await sendTelegramMessage(chatId, 'üìù –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—É—Å—Ç');
                return;
            }

            let message = 'üìù *–°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤:*\\n\\n';
            questions.forEach((q, index) => {
                message += `*${q.id}. ${q.theme}*\\n`;
                message += `–í–æ–ø—Ä–æ—Å: ${q.text}\\n`;
                if (q.suggestions && q.suggestions.length > 0) {
                    message += `–ü–æ–¥—Å–∫–∞–∑–∫–∏: ${q.suggestions.join(', ')}\\n`;
                }
                if (q.templates && q.templates.length > 0) {
                    message += `–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: ${q.templates.length} —É–º–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤\\n`;
                }
                message += `\\n`;
            });

            message += `–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: ${questions.length}\\n`;
            message += '–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã: /add_bulk';

            await sendTelegramMessage(chatId, message);
        }

        async function addBulkQuestions(chatId, text) {
            if (!text || !text.trim()) {
                await sendTelegramMessage(chatId, 
                    '‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /add_bulk\\n' +
                    'üíí –°–≤–∞–¥—å–±–∞|–í–æ–ø—Ä–æ—Å?|–ø–æ–¥—Å–∫–∞–∑–∫–∏|—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏\\n' +
                    'üå¥ –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è|–í–æ–ø—Ä–æ—Å?|–ø–æ–¥—Å–∫–∞–∑–∫–∏|—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏\\n\\n' +
                    '–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å'
                );
                return;
            }

            const lines = text.split('\n').filter(line => line.trim());
            let addedCount = 0;
            let errors = [];

            for (const line of lines) {
                const parts = line.split('|');
                if (parts.length < 3) {
                    errors.push(`‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: ${line}`);
                    continue;
                }

                const newQuestion = {
                    id: questions.length > 0 ? Math.max(...questions.map(q => q.id)) + 1 : 1,
                    theme: parts[0].trim(),
                    text: parts[1].trim() + (parts[1].trim().endsWith('?') ? '' : '?'),
                    suggestions: parts[2] ? parts[2].split(',').map(s => s.trim()) : [],
                    templates: parts[3] ? parts[3].split(';').map(t => t.trim()) : [
                        "–Ø –¥—É–º–∞—é, —á—Ç–æ {–æ—Ç–≤–µ—Ç}",
                        "–î–ª—è –º–µ–Ω—è —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ {–æ—Ç–≤–µ—Ç}",
                        "–Ø —á—É–≤—Å—Ç–≤—É—é, —á—Ç–æ {–æ—Ç–≤–µ—Ç}",
                        "–ú–æ–π –æ–ø—ã—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ {–æ—Ç–≤–µ—Ç}",
                        "–Ø —Å—á–∏—Ç–∞—é, —á—Ç–æ {–æ—Ç–≤–µ—Ç}"
                    ]
                };

                questions.push(newQuestion);
                addedCount++;
            }

            const success = await saveQuestions(questions);

            if (success) {
                let response = `‚úÖ *–î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} –≤–æ–ø—Ä–æ—Å–æ–≤!*\\n\\n`;
                questions.slice(-addedCount).forEach(q => {
                    response += `*${q.theme}*\\n`;
                    response += `${q.text}\\n`;
                    response += `–ü–æ–¥—Å–∫–∞–∑–∫–∏: ${q.suggestions.join(', ') || '–Ω–µ—Ç'}\\n`;
                    response += `–£–º–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: ${q.templates.length} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤\\n\\n`;
                });
                
                if (errors.length > 0) {
                    response += `*–û—à–∏–±–∫–∏:*\\n${errors.join('\\n')}`;
                }

                await sendTelegramMessage(chatId, response);
                generateQuestionScreens();
            } else {
                await sendTelegramMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤');
                questions.splice(-addedCount); // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            }
        }

        async function editQuestion(chatId, questionId, text) {
            if (!questionId || !text) {
                await sendTelegramMessage(chatId, '‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /edit –Ω–æ–º–µ—Ä_–≤–æ–ø—Ä–æ—Å–∞ —Ç–µ–º–∞|–≤–æ–ø—Ä–æ—Å|–ø–æ–¥—Å–∫–∞–∑–∫–∏|—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏');
                return;
            }

            const id = parseInt(questionId);
            const questionIndex = questions.findIndex(q => q.id === id);

            if (questionIndex === -1) {
                await sendTelegramMessage(chatId, `‚ùå –í–æ–ø—Ä–æ—Å —Å ID ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                return;
            }

            const parts = text.split('|');
            const oldQuestion = {...questions[questionIndex]};

            questions[questionIndex].theme = parts[0].trim();
            questions[questionIndex].text = parts[1].trim() + (parts[1].trim().endsWith('?') ? '' : '?');
            
            if (parts[2]) {
                questions[questionIndex].suggestions = parts[2].split(',').map(s => s.trim());
            }
            
            if (parts[3]) {
                questions[questionIndex].templates = parts[3].split(';').map(t => t.trim());
            }

            const success = await saveQuestions(questions);

            if (success) {
                await sendTelegramMessage(chatId, `‚úÖ *–í–æ–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª–µ–Ω!*\\n\\n*${questions[questionIndex].theme}*\\n${questions[questionIndex].text}`);
                generateQuestionScreens();
            } else {
                await sendTelegramMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞');
                questions[questionIndex] = oldQuestion;
            }
        }

        async function deleteQuestion(chatId, questionId) {
            if (!questionId) {
                await sendTelegramMessage(chatId, '‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /delete –Ω–æ–º–µ—Ä_–≤–æ–ø—Ä–æ—Å–∞');
                return;
            }

            const id = parseInt(questionId);
            const questionIndex = questions.findIndex(q => q.id === id);

            if (questionIndex === -1) {
                await sendTelegramMessage(chatId, `‚ùå –í–æ–ø—Ä–æ—Å —Å ID ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                return;
            }

            const deletedQuestion = questions.splice(questionIndex, 1)[0];
            const success = await saveQuestions(questions);

            if (success) {
                await sendTelegramMessage(chatId, `‚úÖ *–í–æ–ø—Ä–æ—Å —É–¥–∞–ª–µ–Ω!*\\n\\n*${deletedQuestion.theme}*\\n${deletedQuestion.text}`);
                generateQuestionScreens();
            } else {
                await sendTelegramMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞');
                questions.splice(questionIndex, 0, deletedQuestion);
            }
        }

        async function refreshQuestions(chatId) {
            const newQuestions = await loadQuestions();
            questions = newQuestions;
            generateQuestionScreens();
            await sendTelegramMessage(chatId, `‚úÖ –í–æ–ø—Ä–æ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã! –í—Å–µ–≥–æ: ${questions.length}`);
        }

        // ==================== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ü–†–û–°–ù–ò–ö–ê ====================
        const poems = [
            {
                title: "–õ—é–±–æ–≤—å - —ç—Ç–æ –≤–µ—á–Ω–æ—Å—Ç—å",
                text: `–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –≤–µ—á–Ω–æ—Å—Ç—å, —á—Ç–æ –≤ —Å–µ—Ä–¥—Ü–µ –∂–∏–≤—ë—Ç,\n–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ —Ç–æ, —á—Ç–æ –Ω–∞—Å –∫ —Å—á–∞—Å—Ç—å—é –≤–µ–¥—ë—Ç.\n–û–Ω–∞, –∫–∞–∫ —Ä–æ—Å–∞ –Ω–∞ —Ä–∞—Å—Å–≤–µ—Ç–Ω—ã—Ö –ø–æ–ª—è—Ö,\n–û–Ω–∞ ‚Äî –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω—å–µ –≤ —Ç–≤–æ–∏—Ö –∏ –º–æ–∏—Ö –º–µ—á—Ç–∞—Ö.\n\n–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –≤–µ—Ä–∞, –Ω–∞–¥–µ–∂–¥–∞, —Ç–µ–ø–ª–æ,\n–ß—Ç–æ –¥—É—à—É —Å–æ–≥—Ä–µ–µ—Ç –∏ –∫ –Ω–µ–±—É –≤–æ–∑—å–º—ë—Ç.\n–í –Ω–µ–π —Ä–∞–¥–æ—Å—Ç—å –∏ –≥—Ä—É—Å—Ç—å, –≤ –Ω–µ–π –ø–µ—á–∞–ª—å –∏ –≤–æ—Å—Ç–æ—Ä–≥,\n–û–Ω–∞ ‚Äî –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π, –±–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∑–ª—ë—Ç.`
            },
            {
                title: "–¢—ã - –º–æ—ë –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ", 
                text: `–¢—ã ‚Äî –º–æ—ë –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω—å–µ, —Ç—ã ‚Äî —Å–≤–µ—Ç –º–æ–∏—Ö –≥–ª–∞–∑,\n–¢—ã ‚Äî —É—Ç—Ä–µ–Ω–Ω–∏–π –≤–µ—Ç–µ—Ä, —Ç—ã ‚Äî –ª–∞—Å–∫–æ–≤—ã–π —á–∞—Å.\n–í —Ç–≤–æ–∏—Ö –æ–±—ä—è—Ç—å—è—Ö —Ç–µ—Ä—è—é —è —Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∞–º,\n–¢—ã ‚Äî –ª—É—á—à–∞—è —Å–∫–∞–∑–∫–∞, —á—Ç–æ —è –ø—Ä–æ—á–∏—Ç–∞–ª.\n\n–¢—ã ‚Äî –º—É–∑—ã–∫–∞ —Å–µ—Ä–¥—Ü–∞, —Ç—ã ‚Äî —Ä–∏—Ç–º –∏ –ø–æ–∫–æ–π,\n–¢—ã ‚Äî –∞–Ω–≥–µ–ª-—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å, –≤—Å–µ–≥–¥–∞ –∑–∞ —Å–ø–∏–Ω–æ–π.\n–° —Ç–æ–±–æ—é –ª—é–±–æ–µ –Ω–µ–Ω–∞—Å—Ç—å–µ ‚Äî –Ω–µ –±–µ–¥–∞,\n–í–µ–¥—å —Ç—ã ‚Äî –º–æ—è –≥–æ—Ä–¥–æ—Å—Ç—å, –º–µ—á—Ç–∞ –∏ –∑–≤–µ–∑–¥–∞.`
            }
        ];

        function generateQuestionScreens() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            questions.forEach((question, index) => {
                const questionNumber = index + 1;
                const progressWidth = (questionNumber / questions.length) * 100;

                const screenHTML = `
                    <div id="screen${questionNumber}" style="display: none;">
                        <h1>${question.theme}</h1>
                        <p class="question-text">${question.text}</p>
                        
                        ${question.suggestions && question.suggestions.length > 0 ? `
                        <div class="suggestion-buttons">
                            ${question.suggestions.map(suggestion => 
                                `<button class="suggestion-btn" onclick="addSuggestion(${questionNumber}, '${suggestion.replace(/'/g, "\\'")}')">${suggestion}</button>`
                            ).join('')}
                        </div>
                        ` : ''}

                        <div class="character-count" id="count${questionNumber}">0/500 —Å–∏–º–≤–æ–ª–æ–≤</div>
                        <textarea class="user-input" id="input${questionNumber}" 
                                  placeholder="–ù–∞–ø–∏—à–∏ –∑–¥–µ—Å—å –≤—Å—ë, —á—Ç–æ —Å—á–∏—Ç–∞–µ—à—å –≤–∞–∂–Ω—ã–º... üí≠" 
                                  maxlength="500" 
                                  oninput="updateCharacterCount(${questionNumber})"></textarea>
                        
                        <div class="buttons">
                            <button class="btn btn-primary" onclick="saveAnswer(${questionNumber})">üíñ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                            <button class="btn btn-success" onclick="showFormulation(${questionNumber})">‚ú® –ö—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–∏—Ç—å</button>
                        </div>

                        <div class="formulation-section" id="formulation${questionNumber}">
                            <div class="formulation-text" id="formulationText${questionNumber}"></div>
                            <div class="buttons">
                                <button class="btn btn-success" onclick="acceptFormulation(${questionNumber})">‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                                <button class="btn btn-primary" onclick="reformulate(${questionNumber})">üîÑ –î—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç</button>
                            </div>
                        </div>

                        <div class="progress">
                            <div class="progress-bar" style="width: ${progressWidth}%"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += screenHTML;
            });
        }

        function startQuestions() {
            document.getElementById('screen-welcome').style.display = 'none';
            showScreen(1);
        }

        function showScreen(screenNumber) {
            document.querySelectorAll('#questions-container > div').forEach(screen => {
                screen.style.display = 'none';
            });
            const targetScreen = document.getElementById(`screen${screenNumber}`);
            if (targetScreen) {
                targetScreen.style.display = 'block';
            }
            currentQuestion = screenNumber;
        }

        function updateCharacterCount(questionNum) {
            const input = document.getElementById(`input${questionNum}`);
            const count = document.getElementById(`count${questionNum}`);
            if (input && count) {
                count.textContent = `${input.value.length}/500 —Å–∏–º–≤–æ–ª–æ–≤`;
            }
        }

        function addSuggestion(questionNum, text) {
            const input = document.getElementById(`input${questionNum}`);
            if (input) {
                const currentText = input.value.trim();
                if (currentText === '') {
                    input.value = text;
                } else {
                    const lastChar = currentText.slice(-1);
                    const connectors = ['.', '!', '?', ';', ','];
                    const separator = connectors.includes(lastChar) ? ' ' : '. ';
                    input.value = currentText + separator + text;
                }
                updateCharacterCount(questionNum);
            }
        }

        function saveAnswer(questionNum) {
            const input = document.getElementById(`input${questionNum}`);
            if (!input) return;

            const userText = input.value.trim();
            if (userText.length < 3) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏ –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ ü§ó');
                return;
            }

            userAnswers[questionNum] = {
                original: userText,
                formulated: userText
            };

            if (questionNum < questions.length) {
                showScreen(questionNum + 1);
            } else {
                showFinalScreen();
            }
        }

        function showFormulation(questionNum) {
            const input = document.getElementById(`input${questionNum}`);
            if (!input) return;

            const userText = input.value.trim();
            if (userText.length < 3) {
                alert('–ù–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å–ª–æ–≤ üí≠');
                return;
            }

            const formulation = generateSmartFormulation(questionNum, userText);
            const formulationDiv = document.getElementById(`formulation${questionNum}`);
            const formulationText = document.getElementById(`formulationText${questionNum}`);

            if (formulationDiv && formulationText) {
                formulationText.innerHTML = formulation;
                formulationDiv.style.display = 'block';
                
                userAnswers[questionNum] = {
                    original: userText,
                    formulated: formulation
                };
            }
        }

        function acceptFormulation(questionNum) {
            const formulationDiv = document.getElementById(`formulation${questionNum}`);
            if (formulationDiv) {
                formulationDiv.style.display = 'none';
            }

            if (questionNum < questions.length) {
                showScreen(questionNum + 1);
            } else {
                showFinalScreen();
            }
        }

        function reformulate(questionNum) {
            const input = document.getElementById(`input${questionNum}`);
            if (!input) return;

            const userText = input.value.trim();
            const newFormulation = generateSmartFormulation(questionNum, userText);
            const formulationText = document.getElementById(`formulationText${questionNum}`);

            if (formulationText) {
                formulationText.innerHTML = newFormulation;
                userAnswers[questionNum].formulated = newFormulation;
            }
        }

        function showFinalScreen() {
            document.getElementById('questions-container').style.display = 'none';
            document.getElementById('screen-final').style.display = 'block';
            
            const randomPoem = poems[Math.floor(Math.random() * poems.length)];
            document.getElementById('finalPoem').innerHTML = `
                <div class="poem-title">${randomPoem.title}</div>
                <div class="poem-text">${randomPoem.text}</div>
            `;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ Telegram
            sendResultsToTelegram();
        }

        async function sendResultsToTelegram() {
            let message = `üí´ *–ù–û–í–´–ï –û–¢–í–ï–¢–´!*\\n\\n`;

            for (let i = 1; i <= questions.length; i++) {
                if (userAnswers[i]) {
                    const question = questions[i-1];
                    message += `*${question.theme}*\\n`;
                    message += `üìù *–û—Ç–≤–µ—Ç:* ${userAnswers[i].formulated}\\n\\n`;
                }
            }

            message += `*–í—Ä–µ–º—è:* ${new Date().toLocaleString('ru-RU')}\\n`;
            message += `*–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤:* ${questions.length}`;

            await sendTelegramMessage(CHAT_ID, message);
        }

        function restartQuiz() {
            userAnswers = {};
            currentQuestion = 0;
            
            document.querySelectorAll('.user-input').forEach(input => input.value = '');
            document.querySelectorAll('.character-count').forEach(count => count.textContent = '0/500 —Å–∏–º–≤–æ–ª–æ–≤');
            document.querySelectorAll('.formulation-section').forEach(form => form.style.display = 'none');
            
            document.getElementById('screen-final').style.display = 'none';
            document.getElementById('questions-container').style.display = 'block';
            document.getElementById('screen-welcome').style.display = 'block';
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        async function initializeApp() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            questions = await loadQuestions();
            console.log('‚úÖ –í–æ–ø—Ä–æ—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', questions);
            
            generateQuestionScreens();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
            setInterval(checkBotMessages, 3000);
            
            console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
