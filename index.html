<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–∑–Ω–∞—é —Ç–≤–æ—é –¥—É—à—É –ª—É—á—à–µ üí´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* –°–¢–ò–õ–ò –ú–£–ó–´–ö–ê–õ–¨–ù–û–ì–û –ü–õ–ï–ï–†–ê */
        .music-player {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            width: 320px;
            z-index: 1000;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .music-player:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .player-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .player-title {
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .now-playing {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 0.9em;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .play-btn {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.3);
        }

        .progress-container {
            flex-grow: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .progress-bar-music {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.8), rgba(102, 126, 234, 0.8));
            width: 0%;
            transition: width 0.1s linear;
        }

        .time-display {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
        }

        .volume-slider {
            width: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 4px;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            cursor: pointer;
        }

        .track-info {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            margin-top: 5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .music-notice {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            margin-top: 5px;
            font-style: italic;
        }

        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 700px;
            width: 100%;
            position: relative;
            min-height: 600px;
            margin: 20px auto;
            transition: all 0.3s ease;
        }

        .screen {
            display: none;
            animation: fadeInUp 0.8s ease;
        }

        .active {
            display: block;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.2em;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .question-text {
            font-size: 1.4em;
            color: #555;
            margin-bottom: 30px;
            line-height: 1.6;
            min-height: 80px;
            text-align: center;
        }

        .input-section {
            margin: 30px 0;
        }

        .user-input {
            width: 100%;
            min-height: 120px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1.1em;
            font-family: 'Arial', sans-serif;
            resize: vertical;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .user-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .character-count {
            text-align: right;
            color: #666;
            font-size: 0.9em;
            margin-top: -15px;
            margin-bottom: 15px;
        }

        .formulation-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin: 25px 0;
            text-align: left;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .formulation-text {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .poem-container {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            text-align: center;
        }

        .poem-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            font-style: italic;
        }

        .poem-text {
            font-size: 1.3em;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-line;
        }

        .progress {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 25px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .suggestion-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
        }

        .suggestion-btn {
            padding: 8px 16px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .suggestion-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .hearts-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .heart {
            position: absolute;
            font-size: 24px;
            opacity: 0;
            animation: float 6s ease-in infinite;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes float {
            0% {
                transform: translateY(100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- –ú–£–ó–´–ö–ê–õ–¨–ù–´–ô –ü–õ–ï–ï–† -->
    <div class="music-player" id="musicPlayer">
        <div class="player-header">
            <div class="player-title">üéµ –ù–∞—à–∞ –º—É–∑—ã–∫–∞</div>
        </div>
        <div class="now-playing" id="nowPlaying">–ù–∞–∂–º–∏ ‚ñ∂ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è</div>
        <div class="player-controls">
            <button class="control-btn" onclick="previousTrack()">‚èÆ</button>
            <button class="control-btn play-btn" onclick="togglePlay()" id="playBtn">‚ñ∂</button>
            <button class="control-btn" onclick="nextTrack()">‚è≠</button>
        </div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-music" id="musicProgress"></div>
        </div>
        <div class="time-display">
            <span id="currentTime">0:00</span>
            <span id="duration">0:00</span>
        </div>
        <div class="volume-container">
            <span style="color: rgba(255,255,255,0.8);">üîä</span>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50" oninput="setVolume(this.value)">
        </div>
        <div class="track-info" id="trackInfo">1/4</div>
        <div class="music-notice">–ú—É–∑—ã–∫–∞ –¥–ª—è —Ç–≤–æ–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è üíñ</div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† -->
    <div class="container">
        <!-- –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø -->
        <div class="screen active" id="screen-welcome">
            <h1>üíñ –†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ –æ —Å–µ–±–µ</h1>
            <p class="question-text">
                –≠—Ç–æ—Ç –æ–ø—Ä–æ—Å–Ω–∏–∫ –æ—Å–æ–±–µ–Ω–Ω—ã–π - –∑–¥–µ—Å—å –Ω–µ—Ç –≥–æ—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤!<br>
                –ü–∏—à–∏ –≤—Å—ë, —á—Ç–æ –ø—Ä–∏–¥—ë—Ç –≤ –≥–æ–ª–æ–≤—É, –∞ —è –ø–æ–º–æ–≥—É –∫—Ä–∞—Å–∏–≤–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –º—ã—Å–ª–∏.<br>
                –í –∫–æ–Ω—Ü–µ —Ç–µ–±—è –∂–¥—ë—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ! ‚ú®
            </p>
            <div class="buttons">
                <button class="btn btn-primary" onclick="startQuestions()">–ù–∞—á–∞—Ç—å –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä üí´</button>
            </div>
        </div>

        <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –í–û–ü–†–û–°–û–í -->
        <div id="questions-container"></div>

        <!-- –§–ò–ù–ê–õ–¨–ù–´–ô –≠–ö–†–ê–ù -->
        <div class="screen" id="screen-final">
            <h1>–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ—Å—Ç—å! üíñ</h1>
            <div class="poem-container" id="finalPoem">
                <!-- –°—é–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ -->
            </div>
            <p class="question-text">–¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–º–æ–≥–ª–∏ –º–Ω–µ –ø–æ–Ω—è—Ç—å —Ç–µ–±—è –≥–æ—Ä–∞–∑–¥–æ –ª—É—á—à–µ! ‚ú®</p>
            <div class="buttons">
                <button class="btn btn-success" onclick="restartQuiz()">üîÑ –ü—Ä–æ–π—Ç–∏ –µ—â—ë —Ä–∞–∑</button>
            </div>
        </div>

        <div class="hearts-container" id="heartsContainer"></div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const BOT_TOKEN = '8519621124:AAEtDBYSAeNW16UQiAGy0epAwwt989v9Tzs';
        const CHAT_ID = '1490495592';
        const JSONBIN_ID = '690bda1cae596e708f473589';
        const JSONBIN_API_KEY = '$2a$10$nFkbrwHZpy3T9KrGUS6RxecAFiNTyKuGe.DZjFqoWYEUcbGS27YRC';

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let userAnswers = {};
        let currentQuestion = 0;
        let questions = [];
        let lastUpdateId = 0;
        let audio, isPlaying = false, currentTrack = 0, updateInterval;
        let audioInitialized = false;

        // –ú–£–ó–´–ö–ê–õ–¨–ù–´–ï –¢–†–ï–ö–ò
        const tracks = [
            {
                name: "–ù–∞—à–∞ –∂–∏–∑–Ω—å - 2hug",
                url: "https://github.com/staralex197/romantic-questionnaire/raw/refs/heads/main/Music/2hug_-_Nasha_zhizn_79029104.mp3",
                duration: "3:11"
            },
            {
                name: "–¢—ã —Ç–∞... - –ë–∞—Å—Ç–∞",
                url: "https://github.com/staralex197/romantic-questionnaire/raw/refs/heads/main/Music/Basta_-_Ty_ta_61892966.mp3",
                duration: "3:56"
            },
            {
                name: "–ü—Ä–∏–≤–µ—Ç - MATRANG, –ë–∞—Å—Ç–∞",
                url: "https://github.com/staralex197/romantic-questionnaire/raw/refs/heads/main/Music/MATRANG_-_Privet_64870751.mp3",
                duration: "3:13"
            },
            {
                name: "–ë–æ–π—Å–±—ç–Ω–¥ - PHARAON, Ca$$xttx",
                url: "https://github.com/staralex197/romantic-questionnaire/raw/refs/heads/main/Music/PHARAOH_Caxttx_-_Bojjsbjend_64493563.mp3",
                duration: "2:58"
            }
        ];

        // ==================== –ú–£–ó–´–ö–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function formatTime(seconds) {
            if (isNaN(seconds)) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function initializeAudio() {
            if (!audioInitialized) {
                audioInitialized = true;
                audio = new Audio();
                audio.volume = 0.5;
                audio.src = tracks[0].url;
                audio.load();
                document.getElementById('nowPlaying').textContent = tracks[0].name;
                document.getElementById('trackInfo').textContent = `1/${tracks.length}`;
                
                audio.addEventListener('ended', function() {
                    nextTrack();
                });
            }
        }

        function togglePlay() {
            if (!audioInitialized) {
                initializeAudio();
            }

            if (isPlaying) {
                audio.pause();
                document.getElementById('playBtn').textContent = '‚ñ∂';
                isPlaying = false;
                stopProgressUpdate();
            } else {
                audio.play().then(() => {
                    document.getElementById('playBtn').textContent = '‚è∏';
                    isPlaying = true;
                    startProgressUpdate();
                }).catch(error => {
                    console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
                });
            }
        }

        function startProgressUpdate() {
            updateInterval = setInterval(() => {
                if (audio.duration) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    document.getElementById('musicProgress').style.width = progress + '%';
                    document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
                }
            }, 1000);
        }

        function stopProgressUpdate() {
            clearInterval(updateInterval);
        }

        function setVolume(volume) {
            if (audio) {
                audio.volume = volume / 100;
            }
        }

        function nextTrack() {
            currentTrack = (currentTrack + 1) % tracks.length;
            loadTrack(currentTrack);
        }

        function previousTrack() {
            currentTrack = (currentTrack - 1 + tracks.length) % tracks.length;
            loadTrack(currentTrack);
        }

        function loadTrack(index) {
            if (!audioInitialized) {
                initializeAudio();
            }

            currentTrack = index;
            audio.src = tracks[index].url;
            document.getElementById('musicProgress').style.width = '0%';
            document.getElementById('currentTime').textContent = '0:00';
            
            audio.play().then(() => {
                isPlaying = true;
                document.getElementById('playBtn').textContent = '‚è∏';
                document.getElementById('nowPlaying').textContent = tracks[index].name;
                document.getElementById('trackInfo').textContent = `${currentTrack + 1}/${tracks.length}`;
                document.getElementById('duration').textContent = tracks[index].duration;
                startProgressUpdate();
            }).catch(error => {
                console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
            });
        }

        // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –ø–æ –∫–ª–∏–∫—É
        document.getElementById('progressContainer').addEventListener('click', function(e) {
            if (!audio || !audio.duration) return;
            const rect = this.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audio.currentTime = percent * audio.duration;
        });

        // ==================== –£–ú–ù–´–ï –§–û–†–ú–£–õ–ò–†–û–í–ö–ò ====================
        function applySmartTemplate(template, userText) {
            const cleanText = userText.trim().replace(/[.!?]$/, '');
            const lowerText = cleanText.toLowerCase();
            
            return template
                .replace(/{–æ—Ç–≤–µ—Ç\.–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π}/g, formatPrepositional(lowerText))
                .replace(/{–æ—Ç–≤–µ—Ç\.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π}/g, formatNominative(cleanText))
                .replace(/{–æ—Ç–≤–µ—Ç\.—Å–æ—é–∑}/g, formatConjunction(lowerText))
                .replace(/{–æ—Ç–≤–µ—Ç}/g, lowerText);
        }

        function formatPrepositional(text) {
            if (text.endsWith('–∞') || text.endsWith('—è')) {
                return text.slice(0, -1) + '–µ';
            }
            if (text.endsWith('–æ—Å—Ç—å') || text.endsWith('–∞—Å—Ç—å')) {
                return text.slice(0, -2) + '–æ—Å—Ç–∏';
            }
            if (text.endsWith('–∏–µ')) {
                return text.slice(0, -1) + '–∏';
            }
            return text;
        }

        function formatNominative(text) {
            return text.charAt(0).toUpperCase() + text.slice(1);
        }

        function formatConjunction(text) {
            if (text.endsWith('—Ç—å')) {
                return text + '—å';
            }
            if (text.endsWith('—Ç—å—Å—è')) {
                return text;
            }
            if (text.endsWith('–∞') || text.endsWith('—è')) {
                return text.slice(0, -1) + '–ª–∞';
            }
            return text;
        }

        function generateSmartFormulation(questionNum, userText) {
            const question = questions[questionNum - 1];
            
            if (question.templates && question.templates.length > 0) {
                const template = question.templates[Math.floor(Math.random() * question.templates.length)];
                return applySmartTemplate(template, userText);
            }
            
            return generateFallbackFormulation(questionNum, userText);
        }

        function generateFallbackFormulation(questionNum, userText) {
            const cleanText = userText.toLowerCase().replace(/[.!?]$/, '');
            const formulations = [
                `–Ø –¥—É–º–∞—é, —á—Ç–æ ${cleanText}`,
                `–î–ª—è –º–µ–Ω—è —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ ${cleanText}`,
                `–Ø —á—É–≤—Å—Ç–≤—É—é, —á—Ç–æ ${cleanText}`,
                `–ú–æ–π –æ–ø—ã—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ ${cleanText}`,
                `–Ø —Å—á–∏—Ç–∞—é, —á—Ç–æ ${cleanText}`
            ];
            
            return formulations[Math.floor(Math.random() * formulations.length)];
        }

        // ==================== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ====================
        const poems = [
            {
                title: "–¢–≤–æ—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è üí´",
                text: `–í —Ç–≤–æ–∏—Ö —Å–ª–æ–≤–∞—Ö - —Ü–µ–ª–∞—è –≤—Å–µ–ª–µ–Ω–Ω–∞—è,\n–ò—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å, —á—Ç–æ —Å–≤–µ—Ç–∏—Ç—Å—è –∏–∑–Ω—É—Ç—Ä–∏.\n–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç - –∫–∞–∫ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ü–µ–Ω–Ω–∞—è,\n–†–∞—Å—Å–∫–∞–∑–∞–Ω–Ω–∞—è –æ—Ç –≤—Å–µ–π –¥—É—à–∏.\n\n–¢—ã - –æ—Å–æ–±–µ–Ω–Ω–∞—è, –≤ —ç—Ç–æ–º –Ω–µ—Ç —Å–æ–º–Ω–µ–Ω–∏–π,\n–ò –≤ –∫–∞–∂–¥–æ–º —Å–ª–æ–≤–µ —Ç–≤–æ—ë–º - –∫—Ä–∞—Å–æ—Ç–∞.\n–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–µ–ª–∏—à—å—Å—è —Å–≤–æ–∏–º–∏ –º–≥–Ω–æ–≤–µ–Ω–∏—è–º–∏,\n–í —ç—Ç–æ–º - —Ç–≤–æ—è –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–æ—Å—Ç–æ—Ç–∞!`
            },
            {
                title: "–û–¥–∞ —Ç–≤–æ–µ–π –¥—É—à–µ üå∏", 
                text: `–°–ª–æ–≤–∞ —Ç–≤–æ–∏ - –∫–∞–∫ –º—É–∑—ã–∫–∞ –¥–ª—è —Å–µ—Ä–¥—Ü–∞,\n–í –Ω–∏—Ö —Å—Ç–æ–ª—å–∫–æ —Ç–µ–ø–ª–∞, –Ω–µ–∂–Ω–æ—Å—Ç–∏, —Å–≤–µ—Ç–∞.\n–¢—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –¥—É—à—É –±–µ–∑ –∫–æ–Ω—Ü–∞,\n–ò –≤ —ç—Ç–æ–º - —Ç–≤–æ—è –æ—Å–æ–±–∞—è –ø—Ä–∏–º–µ—Ç–∞.\n\n–ö–∞–∂–¥–∞—è –º—ã—Å–ª—å - –∫–∞–∫ –¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–π –∫–∞–º–µ–Ω—å,\n–ò—Å–∫—Ä–µ–Ω–Ω—è—è, —á–∏—Å—Ç–∞—è, –Ω–∞—Å—Ç–æ—è—â–∞—è.\n–¢—ã –¥–∞—Ä–∏—à—å —ç—Ç–æ–º—É –º–∏—Ä—É —Å–≤–æ—é –ª—é–±–æ–≤—å,\n–ò –≤ —ç—Ç–æ–º - —Ç–≤–æ—è —Å—É—Ç—å –Ω–∞—Å—Ç–æ—è—â–∞—è!`
            }
        ];

        function generateQuestionScreens() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            questions.forEach((question, index) => {
                const questionNumber = index + 1;
                const progressWidth = (questionNumber / questions.length) * 100;

                const screenHTML = `
                    <div class="screen" id="screen${questionNumber}">
                        <h1>${question.theme}</h1>
                        <p class="question-text">${question.text}</p>
                        
                        ${question.suggestions && question.suggestions.length > 0 ? `
                        <div class="suggestion-buttons">
                            ${question.suggestions.map(suggestion => 
                                `<button class="suggestion-btn" onclick="addSuggestion(${questionNumber}, '${suggestion.replace(/'/g, "\\'")}')">${suggestion}</button>`
                            ).join('')}
                        </div>
                        ` : ''}

                        <div class="input-section">
                            <div class="character-count" id="count${questionNumber}">0/500 —Å–∏–º–≤–æ–ª–æ–≤</div>
                            <textarea class="user-input" id="input${questionNumber}" 
                                      placeholder="–ù–∞–ø–∏—à–∏ –∑–¥–µ—Å—å –≤—Å—ë, —á—Ç–æ —Å—á–∏—Ç–∞–µ—à—å –≤–∞–∂–Ω—ã–º... üí≠" 
                                      maxlength="500" 
                                      oninput="updateCharacterCount(${questionNumber})"></textarea>
                            
                            <div class="buttons">
                                <button class="btn btn-primary" onclick="saveAnswer(${questionNumber})">üíñ –ó–∞–ø–∏—Å–∞—Ç—å –º–æ–π –æ—Ç–≤–µ—Ç</button>
                                <button class="btn btn-secondary" onclick="showFormulation(${questionNumber})">‚ú® –ö—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–∏—Ç—å</button>
                            </div>
                        </div>

                        <div class="formulation-section" id="formulation${questionNumber}">
                            <div class="formulation-text" id="formulationText${questionNumber}"></div>
                            <div class="buttons">
                                <button class="btn btn-success" onclick="acceptFormulation(${questionNumber})">‚úÖ –ù—Ä–∞–≤–∏—Ç—Å—è</button>
                                <button class="btn btn-secondary" onclick="reformulate(${questionNumber})">üîÑ –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å</button>
                            </div>
                        </div>

                        <div class="progress">
                            <div class="progress-bar" style="width: ${progressWidth}%"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += screenHTML;
            });
        }

        function startQuestions() {
            if (questions.length === 0) {
                alert('–í–æ–ø—Ä–æ—Å—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ');
                return;
            }
            nextScreen('screen1');
            createHearts();
        }

        function nextScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
        }

        function updateCharacterCount(questionNum) {
            const input = document.getElementById(`input${questionNum}`);
            const count = document.getElementById(`count${questionNum}`);
            if (input && count) {
                count.textContent = `${input.value.length}/500 —Å–∏–º–≤–æ–ª–æ–≤`;
            }
        }

        function addSuggestion(questionNum, text) {
            const input = document.getElementById(`input${questionNum}`);
            if (input) {
                const currentText = input.value.trim();
                if (currentText === '') {
                    input.value = text;
                } else {
                    const lastChar = currentText.slice(-1);
                    const connectors = ['.', '!', '?', ';', ','];
                    const separator = connectors.includes(lastChar) ? ' ' : '. ';
                    input.value = currentText + separator + text;
                }
                updateCharacterCount(questionNum);
            }
        }

        function saveAnswer(questionNum) {
            const input = document.getElementById(`input${questionNum}`);
            if (!input) return;

            const userText = input.value.trim();
            if (userText.length < 3) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏ –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ ü§ó');
                return;
            }

            userAnswers[questionNum] = {
                original: userText,
                formulated: userText
            };

            moveToNextQuestion(questionNum);
        }

        function showFormulation(questionNum) {
            const input = document.getElementById(`input${questionNum}`);
            if (!input) return;

            const userText = input.value.trim();
            if (userText.length < 3) {
                alert('–ù–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å–ª–æ–≤ üí≠');
                return;
            }

            const formulation = generateSmartFormulation(questionNum, userText);
            const formulationDiv = document.getElementById(`formulation${questionNum}`);
            const formulationText = document.getElementById(`formulationText${questionNum}`);

            if (formulationDiv && formulationText) {
                formulationText.innerHTML = formulation;
                formulationDiv.style.display = 'block';
                
                userAnswers[questionNum] = {
                    original: userText,
                    formulated: formulation
                };
            }
        }

        function acceptFormulation(questionNum) {
            const formulationDiv = document.getElementById(`formulation${questionNum}`);
            if (formulationDiv) {
                formulationDiv.style.display = 'none';
            }
            moveToNextQuestion(questionNum);
        }

        function reformulate(questionNum) {
            const input = document.getElementById(`input${questionNum}`);
            if (!input) return;

            const userText = input.value.trim();
            const newFormulation = generateSmartFormulation(questionNum, userText);
            const formulationText = document.getElementById(`formulationText${questionNum}`);

            if (formulationText) {
                formulationText.innerHTML = newFormulation;
                userAnswers[questionNum].formulated = newFormulation;
            }
        }

        function moveToNextQuestion(currentQ) {
            if (currentQ < questions.length) {
                nextScreen('screen' + (currentQ + 1));
                createHearts();
            } else {
                showFinalScreen();
            }
        }

        function showFinalScreen() {
            nextScreen('screen-final');
            
            const randomPoem = poems[Math.floor(Math.random() * poems.length)];
            document.getElementById('finalPoem').innerHTML = `
                <div class="poem-title">${randomPoem.title}</div>
                <div class="poem-text">${randomPoem.text}</div>
            `;

            sendResultsToTelegram();
        }

        async function sendResultsToTelegram() {
            let message = `üí´ *–ù–û–í–´–ï –û–¢–í–ï–¢–´!*\\n\\n`;

            for (let i = 1; i <= questions.length; i++) {
                if (userAnswers[i]) {
                    const question = questions[i-1];
                    message += `*${question.theme}*\\n`;
                    message += `üìù *–û—Ç–≤–µ—Ç:* ${userAnswers[i].formulated}\\n\\n`;
                }
            }

            message += `*–í—Ä–µ–º—è:* ${new Date().toLocaleString('ru-RU')}\\n`;
            message += `*–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤:* ${questions.length}`;

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ)
            try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', error);
            }
        }

        function createHearts() {
            const container = document.getElementById('heartsContainer');
            if (container) {
                container.innerHTML = '';
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const heart = document.createElement('div');
                        heart.className = 'heart';
                        heart.innerHTML = 'üíñ';
                        heart.style.left = Math.random() * 100 + '%';
                        heart.style.animationDelay = Math.random() * 2 + 's';
                        container.appendChild(heart);
                    }, i * 400);
                }
            }
        }

        function restartQuiz() {
            userAnswers = {};
            currentQuestion = 0;
            
            document.querySelectorAll('.user-input').forEach(input => input.value = '');
            document.querySelectorAll('.character-count').forEach(count => count.textContent = '0/500 —Å–∏–º–≤–æ–ª–æ–≤');
            document.querySelectorAll('.formulation-section').forEach(form => form.style.display = 'none');
            
            nextScreen('screen-welcome');
            createHearts();
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        async function initializeApp() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    questions = data.record.questions || getDefaultQuestions();
                } else {
                    questions = getDefaultQuestions();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
                questions = getDefaultQuestions();
            }

            console.log('‚úÖ –í–æ–ø—Ä–æ—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', questions);
            generateQuestionScreens();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ
            initializeAudio();
            
            console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        }

        function getDefaultQuestions() {
            return [
                {
                    id: 1,
                    text: "–û–ø–∏—à–∏, –≤ —á—ë–º —Ç–≤–æ—è —Å–∞–º–∞—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞? –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è –æ—Å–æ–±–µ–Ω–Ω—ã–º?",
                    theme: "üåü –¢–≤–æ—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å",
                    suggestions: ["–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–ó–∞–±–æ—Ç–∞", "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å", "–°–∏–ª–∞ –≤–æ–ª–∏"],
                    templates: [
                        "–ú–æ—è —Å–∏–ª–∞ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ {–æ—Ç–≤–µ—Ç}",
                        "–Ø –æ—Å–æ–±–µ–Ω–Ω–æ —Ü–µ–Ω—é –≤ —Å–µ–±–µ: {–æ—Ç–≤–µ—Ç.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π}",
                        "–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–µ–Ω—è –æ—Å–æ–±–µ–Ω–Ω—ã–º: {–æ—Ç–≤–µ—Ç}",
                        "–ú–æ—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è —á–µ—Ä—Ç–∞ - {–æ—Ç–≤–µ—Ç}",
                        "–Ø –≥–æ—Ä–∂—É—Å—å —Å–≤–æ–µ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é {–æ—Ç–≤–µ—Ç.—Å–æ—é–∑}"
                    ]
                },
                {
                    id: 2,
                    text: "–ö–∞–∫–∞—è —É —Ç–µ–±—è —Å–∞–º–∞—è –∑–∞–≤–µ—Ç–Ω–∞—è –º–µ—á—Ç–∞? –û —á—ë–º —Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ —Ñ–∞–Ω—Ç–∞–∑–∏—Ä—É–µ—à—å?",
                    theme: "üåà –¢–≤–æ–∏ –º–µ—á—Ç—ã",
                    suggestions: ["–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", "–°–µ–º—å—è", "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ", "–ü–æ–º–æ—â—å –¥—Ä—É–≥–∏–º", "–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç"],
                    templates: [
                        "–Ø –º–µ—á—Ç–∞—é –æ —Ç–æ–º, —á—Ç–æ–±—ã {–æ—Ç–≤–µ—Ç.—Å–æ—é–∑}",
                        "–ú–æ–∏ —Å–∞–º—ã–µ —Å–æ–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ –∂–µ–ª–∞–Ω–∏—è: {–æ—Ç–≤–µ—Ç.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π}",
                        "–í —Å–≤–æ–∏—Ö —Ñ–∞–Ω—Ç–∞–∑–∏—è—Ö —è –≤–∏–∂—É: {–æ—Ç–≤–µ—Ç}",
                        "–Ø —Å—Ç—Ä–µ–º–ª—é—Å—å –∫: {–æ—Ç–≤–µ—Ç.–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π}",
                        "–ú–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å: {–æ—Ç–≤–µ—Ç}"
                    ]
                }
            ];
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
